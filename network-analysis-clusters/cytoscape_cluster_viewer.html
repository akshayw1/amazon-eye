<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Eye - Cytoscape Cluster Analysis</title>
    <script src="https://unpkg.com/cytoscape@3.32.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
    <script src="https://unpkg.com/cytoscape-cola@2.5.1/cytoscape-cola.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/layout-base@1.0.2/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base@1.0.3/cose-base.js"></script>
    <script src="https://unpkg.com/cytoscape-popper@2.0.0/cytoscape-popper.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn.active {
            background: #28a745;
            transform: scale(1.05);
        }

        .info-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .info-card {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .info-card h3 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .info-card p {
            margin: 0;
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }

        #cy {
            width: 100%;
            height: 600px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #fafafa;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .legend h4 {
            margin-top: 0;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .breadcrumb {
            margin-bottom: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .breadcrumb a {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .layout-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .layout-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Amazon Eye</h1>
        <p class="subtitle">Advanced Cytoscape.js Cluster Analysis & Product Trust Visualization</p>
        
        <div class="controls">
            <div class="view-toggle">
                <button class="btn btn-primary active" id="cluster-view">Cluster Overview</button>
                <button class="btn btn-secondary" id="product-view" disabled>Product Details</button>
            </div>
            
            <div class="layout-controls">
                <label for="layout-select">Layout:</label>
                <select id="layout-select" class="layout-select">
                    <option value="fcose">fCoSE (Force-directed)</option>
                    <option value="cola">Cola</option>
                    <option value="circle">Circle</option>
                    <option value="grid">Grid</option>
                    <option value="concentric">Concentric</option>
                    <option value="breadthfirst">Breadth First</option>
                </select>
                <button class="btn btn-secondary" id="reset-view">Reset View</button>
            </div>
        </div>

        <div class="breadcrumb" id="breadcrumb" style="display: none;">
            <span>Navigation: </span>
            <a id="home-link">Clusters</a>
            <span id="current-path"></span>
        </div>

        <div class="info-panel" id="info-panel">
            <div class="info-card">
                <h3>Total Clusters</h3>
                <p id="total-clusters">-</p>
            </div>
            <div class="info-card">
                <h3>Total Products</h3>
                <p id="total-products">-</p>
            </div>
            <div class="info-card">
                <h3>Fake Products</h3>
                <p id="fake-products">-</p>
            </div>
            <div class="info-card">
                <h3>Overall Risk</h3>
                <p id="overall-risk">-</p>
            </div>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Search clusters or products...">
            
            <div class="filter-controls">
                <button class="btn btn-secondary active" id="filter-all" onclick="filterByRisk('all')">All Clusters</button>
                <button class="btn btn-secondary" id="filter-low" onclick="filterByRisk('low')">Low Risk</button>
                <button class="btn btn-secondary" id="filter-medium" onclick="filterByRisk('medium')">Medium Risk</button>
                <button class="btn btn-secondary" id="filter-high" onclick="filterByRisk('high')">High Risk</button>
                <button class="btn btn-secondary" id="toggle-connections" onclick="toggleConnections()">Hide Connections</button>
                <button class="btn btn-secondary" id="toggle-labels" onclick="toggleLabels()">Hide Labels</button>
            </div>
        </div>

        <div id="cy-container" style="position: relative;">
            <div id="cy"></div>
            <div class="loading" id="loading">Loading cluster data...</div>
            
            <div class="legend" id="legend">
                <h4>Risk Levels</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <span>Low Risk (&lt; 5%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107;"></div>
                    <span>Medium Risk (5-15%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span>High Risk (&gt; 15%)</span>
                </div>
                
                <h4 style="margin-top: 15px;">Connections</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>Risk Similar</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ecdc4;"></div>
                    <span>Size Similar</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #45b7d1;"></div>
                    <span>Rating Similar</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95a5a6;"></div>
                    <span>General</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip element -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Global variables
        let cy;
        let currentView = 'clusters';
        let currentCluster = null;
        let clusterData = [];
        let productData = [];
        let connectionsVisible = true;
        let labelsVisible = true;
        let tooltip;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeCytoscape();
            loadClusterSummary();
            setupEventListeners();
            setupTooltip();
        });

        function setupTooltip() {
            tooltip = document.getElementById('tooltip');
        }

        function setupEventListeners() {
            document.getElementById('cluster-view').addEventListener('click', () => switchView('clusters'));
            document.getElementById('product-view').addEventListener('click', () => switchView('products'));
            document.getElementById('reset-view').addEventListener('click', resetView);
            document.getElementById('home-link').addEventListener('click', resetView);
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('layout-select').addEventListener('change', changeLayout);
        }

        function initializeCytoscape() {
            // Register layout extensions
            if (typeof cytoscape !== 'undefined') {
                if (cytoscapeFcose) {
                    cytoscape.use(cytoscapeFcose);
                }
                if (cytoscapeCola) {
                    cytoscape.use(cytoscapeCola);
                }
            }

            cy = cytoscape({
                container: document.getElementById('cy'),
                
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'data(color)',
                            'width': 'data(size)',
                            'height': 'data(size)',
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'color': '#333',
                            'text-outline-width': 2,
                            'text-outline-color': '#fff',
                            'border-width': 2,
                            'border-color': 'data(borderColor)',
                            'transition-property': 'background-color, border-color, width, height',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 4,
                            'border-color': '#007bff',
                            'background-color': 'data(selectedColor)'
                        }
                    },
                    {
                        selector: 'node.highlighted',
                        style: {
                            'border-width': 4,
                            'border-color': '#ffd700',
                            'z-index': 10
                        }
                    },
                    {
                        selector: 'node.dimmed',
                        style: {
                            'opacity': 0.3
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 'data(width)',
                            'line-color': 'data(color)',
                            'target-arrow-color': 'data(color)',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'opacity': 'data(opacity)',
                            'line-style': 'data(lineStyle)',
                            'transition-property': 'line-color, width, opacity',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'edge.highlighted',
                        style: {
                            'width': 'data(highlightWidth)',
                            'opacity': 0.8,
                            'z-index': 9
                        }
                    },
                    {
                        selector: 'edge.dimmed',
                        style: {
                            'opacity': 0.1
                        }
                    },
                    {
                        selector: '.fake-product',
                        style: {
                            'background-color': '#dc3545',
                            'border-color': '#b71c1c',
                            'text-outline-color': '#ffcccb'
                        }
                    },
                    {
                        selector: '.real-product',
                        style: {
                            'background-color': '#28a745',
                            'border-color': '#1b5e20'
                        }
                    }
                ],

                layout: {
                    name: 'fcose',
                    quality: 'proof',
                    randomize: false,
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 30
                },

                // Interaction options
                minZoom: 0.1,
                maxZoom: 10,
                wheelSensitivity: 0.2,
                boxSelectionEnabled: true,
                selectionType: 'single'
            });

            // Add event listeners for interactions
            cy.on('tap', 'node', handleNodeClick);
            cy.on('mouseover', 'node', handleNodeHover);
            cy.on('mouseout', 'node', handleNodeLeave);
            cy.on('mouseover', 'edge', handleEdgeHover);
            cy.on('mouseout', 'edge', handleEdgeLeave);
            cy.on('tap', handleBackgroundClick);

            // Add viewport events
            cy.on('zoom pan', updateTooltipPosition);
        }

        async function loadClusterSummary() {
            try {
                const response = await fetch('./cluster_summary.csv');
                const csvText = await response.text();
                clusterData = parseCSV(csvText);
                
                updateInfoPanel();
                visualizeClusters();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading cluster data:', error);
                document.getElementById('loading').textContent = 'Error loading data. Please check the CSV files.';
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    const cleanHeader = header.trim();
                    const value = values[index] ? values[index].trim() : '';
                    
                    // Convert numeric fields
                    if (['cluster_id', 'total_products', 'fake_products', 'fake_percentage', 'avg_fake_score', 'avg_review_rating'].includes(cleanHeader)) {
                        row[cleanHeader] = parseFloat(value) || 0;
                    } else {
                        row[cleanHeader] = value;
                    }
                });
                data.push(row);
            }
            return data;
        }

        function updateInfoPanel() {
            const totalClusters = clusterData.length;
            const totalProducts = clusterData.reduce((sum, d) => sum + d.total_products, 0);
            const totalFakeProducts = clusterData.reduce((sum, d) => sum + d.fake_products, 0);
            const overallFakePercentage = ((totalFakeProducts / totalProducts) * 100).toFixed(2);
            
            document.getElementById('total-clusters').textContent = totalClusters;
            document.getElementById('total-products').textContent = totalProducts.toLocaleString();
            document.getElementById('fake-products').textContent = totalFakeProducts.toLocaleString();
            document.getElementById('overall-risk').textContent = `${overallFakePercentage}%`;
        }

        function visualizeClusters() {
            // Clear existing elements
            cy.elements().remove();

            // Create nodes and edges
            const nodes = clusterData.map(d => ({
                data: {
                    id: `cluster_${d.cluster_id}`,
                    clusterId: d.cluster_id,
                    label: `C${d.cluster_id}`,
                    size: getNodeSize(d.total_products),
                    color: getRiskColor(d.fake_percentage),
                    selectedColor: brightenColor(getRiskColor(d.fake_percentage)),
                    borderColor: darkenColor(getRiskColor(d.fake_percentage)),
                    totalProducts: d.total_products,
                    fakeProducts: d.fake_products,
                    fakePercentage: d.fake_percentage,
                    riskAssessment: d.risk_assessment,
                    avgRating: d.avg_review_rating,
                    sizeCategory: d.size_category,
                    type: 'cluster'
                }
            }));

            const edges = createClusterConnections(nodes);

            // Add elements to cytoscape
            cy.add(nodes);
            cy.add(edges);

            // Apply layout
            const layout = cy.layout({
                name: document.getElementById('layout-select').value,
                quality: 'proof',
                randomize: false,
                animate: true,
                animationDuration: 1000,
                fit: true,
                padding: 50,
                // fCoSE specific options
                nodeRepulsion: 4500,
                idealEdgeLength: 100,
                edgeElasticity: 0.45,
                nestingFactor: 0.1
            });

            layout.run();
        }

        function createClusterConnections(nodes) {
            const edges = [];
            const nodeData = nodes.map(n => n.data);

            for (let i = 0; i < nodeData.length; i++) {
                for (let j = i + 1; j < nodeData.length; j++) {
                    const node1 = nodeData[i];
                    const node2 = nodeData[j];
                    
                    // Calculate connection strength based on multiple factors
                    const riskDiff = Math.abs(node1.fakePercentage - node2.fakePercentage);
                    const sizeDiff = Math.abs(node1.totalProducts - node2.totalProducts);
                    const maxSize = Math.max(node1.totalProducts, node2.totalProducts);
                    const sizeRatio = sizeDiff / maxSize;
                    const ratingDiff = Math.abs(node1.avgRating - node2.avgRating);
                    
                    let connectionStrength = 0;
                    let connectionType = 'general';
                    
                    // Risk-based connections (primary)
                    if (riskDiff < 3.0) {
                        connectionStrength += 0.4;
                        if (riskDiff < 1.5) {
                            connectionStrength += 0.3;
                            connectionType = 'risk-similar';
                        }
                    }
                    
                    // Size-based connections (secondary)
                    if (sizeRatio < 0.3) {
                        connectionStrength += 0.2;
                        if (connectionType === 'general') connectionType = 'size-similar';
                    }
                    
                    // Rating-based connections (tertiary)
                    if (ratingDiff < 0.5) {
                        connectionStrength += 0.1;
                        if (connectionType === 'general') connectionType = 'rating-similar';
                    }
                    
                    // Create connection if strength is sufficient
                    if (connectionStrength > 0.3 && Math.random() < connectionStrength) {
                        edges.push({
                            data: {
                                id: `edge_${i}_${j}`,
                                source: node1.id,
                                target: node2.id,
                                strength: connectionStrength,
                                type: connectionType,
                                color: getConnectionColor(connectionType),
                                width: Math.max(1, connectionStrength * 3),
                                highlightWidth: Math.max(2, connectionStrength * 5),
                                opacity: 0.3 + (connectionStrength * 0.5),
                                lineStyle: connectionType === 'general' ? 'dashed' : 'solid'
                            }
                        });
                    }
                }
            }
            return edges;
        }

        function getNodeSize(totalProducts) {
            return Math.max(30, Math.min(80, Math.sqrt(totalProducts) * 3));
        }

        function getRiskColor(fakePercentage) {
            if (fakePercentage >= 15) return '#dc3545'; // High risk - Red
            if (fakePercentage >= 5) return '#ffc107'; // Medium risk - Yellow
            return '#28a745'; // Low risk - Green
        }

        function getConnectionColor(type) {
            switch(type) {
                case 'risk-similar': return '#ff6b6b';
                case 'size-similar': return '#4ecdc4';
                case 'rating-similar': return '#45b7d1';
                default: return '#95a5a6';
            }
        }

        function brightenColor(color) {
            // Simple color brightening
            const colors = {
                '#dc3545': '#ff4757',
                '#ffc107': '#ffd32a',
                '#28a745': '#2ed573'
            };
            return colors[color] || color;
        }

        function darkenColor(color) {
            // Simple color darkening
            const colors = {
                '#dc3545': '#c82333',
                '#ffc107': '#e0a800',
                '#28a745': '#1e7e34'
            };
            return colors[color] || color;
        }

        function handleNodeClick(event) {
            const node = event.target;
            const data = node.data();
            
            if (data.type === 'cluster') {
                currentCluster = data.clusterId;
                loadClusterProducts(data.clusterId);
                updateBreadcrumb(`Cluster ${data.clusterId}`);
                switchView('products');
            }
        }

        function handleNodeHover(event) {
            const node = event.target;
            const data = node.data();
            
            // Highlight connected elements
            highlightConnectedElements(node);
            
            // Show tooltip
            showTooltip(event, data);
        }

        function handleNodeLeave(event) {
            resetHighlight();
            hideTooltip();
        }

        function handleEdgeHover(event) {
            const edge = event.target;
            const data = edge.data();
            
            // Highlight edge and connected nodes
            edge.addClass('highlighted');
            const sourceNode = cy.getElementById(data.source);
            const targetNode = cy.getElementById(data.target);
            sourceNode.addClass('highlighted');
            targetNode.addClass('highlighted');
            
            showEdgeTooltip(event, data);
        }

        function handleEdgeLeave(event) {
            resetHighlight();
            hideTooltip();
        }

        function handleBackgroundClick(event) {
            if (event.target === cy) {
                cy.elements().removeClass('highlighted dimmed');
            }
        }

        function highlightConnectedElements(node) {
            // Reset all elements
            cy.elements().removeClass('highlighted dimmed');
            
            // Dim all elements
            cy.elements().addClass('dimmed');
            
            // Highlight the selected node
            node.removeClass('dimmed').addClass('highlighted');
            
            // Highlight connected edges and nodes
            const connectedEdges = node.connectedEdges();
            const connectedNodes = connectedEdges.connectedNodes();
            
            connectedEdges.removeClass('dimmed').addClass('highlighted');
            connectedNodes.removeClass('dimmed').addClass('highlighted');
        }

        function resetHighlight() {
            cy.elements().removeClass('highlighted dimmed');
        }

        function showTooltip(event, data) {
            if (data.type === 'cluster') {
                // Count connections
                const node = cy.getElementById(data.id);
                const edges = node.connectedEdges();
                const connectionTypes = { 'risk-similar': 0, 'size-similar': 0, 'rating-similar': 0, 'general': 0 };
                
                edges.forEach(edge => {
                    const edgeData = edge.data();
                    connectionTypes[edgeData.type]++;
                });
                
                const content = `
                    <strong>Cluster ${data.clusterId}</strong><br/>
                    Products: ${data.totalProducts.toLocaleString()}<br/>
                    Fake Products: ${data.fakeProducts} (${data.fakePercentage.toFixed(1)}%)<br/>
                    Risk Level: ${data.riskAssessment}<br/>
                    Avg Rating: ${data.avgRating.toFixed(2)}<br/>
                    Size: ${data.sizeCategory}<br/>
                    <hr style="margin: 8px 0;">
                    <strong>Connections: ${edges.length}</strong><br/>
                    ${connectionTypes['risk-similar'] > 0 ? `<span style="color: #ff6b6b;">‚óè Risk Similar: ${connectionTypes['risk-similar']}</span><br/>` : ''}
                    ${connectionTypes['size-similar'] > 0 ? `<span style="color: #4ecdc4;">‚óè Size Similar: ${connectionTypes['size-similar']}</span><br/>` : ''}
                    ${connectionTypes['rating-similar'] > 0 ? `<span style="color: #45b7d1;">‚óè Rating Similar: ${connectionTypes['rating-similar']}</span><br/>` : ''}
                    ${connectionTypes['general'] > 0 ? `<span style="color: #95a5a6;">‚óè General: ${connectionTypes['general']}</span>` : ''}
                `;
                
                tooltip.innerHTML = content;
            } else {
                // Product tooltip
                const content = `
                    <strong>Product ID: ${data.productId || data.id}</strong><br/>
                    Status: ${data.fake ? 'FAKE' : 'REAL'}<br/>
                    Fake Score: ${(data.fakeScore || 0).toFixed(4)}<br/>
                    Rating: ${(data.avgRating || 0).toFixed(2)}<br/>
                    Reviews: ${data.reviews || 0}
                `;
                
                tooltip.innerHTML = content;
            }
            
            updateTooltipPosition(event);
            tooltip.style.opacity = '1';
        }

        function showEdgeTooltip(event, data) {
            const content = `
                <strong>${data.type.replace('-', ' ').toUpperCase()}</strong><br/>
                Connection Strength: ${(data.strength * 100).toFixed(1)}%<br/>
                Type: ${data.type}<br/>
                Width: ${data.width.toFixed(1)}px
            `;
            
            tooltip.innerHTML = content;
            updateTooltipPosition(event);
            tooltip.style.opacity = '1';
        }

        function hideTooltip() {
            tooltip.style.opacity = '0';
        }

        function updateTooltipPosition(event) {
            if (tooltip.style.opacity !== '0') {
                const x = event.originalEvent ? event.originalEvent.clientX : event.clientX || 0;
                const y = event.originalEvent ? event.originalEvent.clientY : event.clientY || 0;
                
                tooltip.style.left = (x + 10) + 'px';
                tooltip.style.top = (y - 10) + 'px';
            }
        }

        async function loadClusterProducts(clusterId) {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = `Loading products from cluster ${clusterId}...`;
                
                const response = await fetch(`./cluster_${clusterId}_data.csv`);
                const csvText = await response.text();
                productData = parseProductCSV(csvText);
                
                visualizeProducts();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading product data:', error);
                document.getElementById('loading').textContent = 'Error loading product data.';
            }
        }

        function parseProductCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    const cleanHeader = header.trim();
                    const value = values[index] ? values[index].trim() : '';
                    
                    // Convert numeric fields
                    if (['product_ID', 'cluster_ID', 'fake', 'fake_score', 'avg_review_rating', 'n_of_reviews'].includes(cleanHeader)) {
                        row[cleanHeader] = parseFloat(value) || 0;
                    } else {
                        row[cleanHeader] = value;
                    }
                });
                data.push(row);
            }
            return data;
        }

        function visualizeProducts() {
            // Clear existing elements
            cy.elements().remove();
            
            // Limit products for performance
            const maxProducts = 2000;
            const displayProducts = productData.slice(0, maxProducts);
            
            // Create product nodes
            const nodes = displayProducts.map(d => ({
                data: {
                    id: `product_${d.product_ID}`,
                    productId: d.product_ID,
                    label: `P${d.product_ID}`,
                    size: Math.max(10, Math.min(25, Math.sqrt(d.n_of_reviews) / 3)),
                    color: d.fake ? '#dc3545' : '#28a745',
                    selectedColor: d.fake ? '#ff4757' : '#2ed573',
                    borderColor: d.fake ? '#b71c1c' : '#1b5e20',
                    fake: d.fake,
                    fakeScore: d.fake_score,
                    avgRating: d.avg_review_rating,
                    reviews: d.n_of_reviews,
                    type: 'product'
                }
            }));

            // Create product connections (connect nearby fake products)
            const edges = createProductConnections(nodes);

            // Add elements to cytoscape
            cy.add(nodes);
            cy.add(edges);

            // Apply appropriate layout for products
            const layout = cy.layout({
                name: 'fcose',
                quality: 'proof',
                randomize: true,
                animate: true,
                animationDuration: 2000,
                fit: true,
                padding: 30,
                nodeRepulsion: 8000,
                idealEdgeLength: 50,
                edgeElasticity: 0.1,
                nestingFactor: 0.01,
                gravity: 0.25,
                numIter: 2500
            });

            layout.run();

            if (productData.length > maxProducts) {
                // Show message about limited display
                setTimeout(() => {
                    showMessage(`Showing first ${maxProducts} of ${productData.length} products for performance`);
                }, 1000);
            }
        }

        function createProductConnections(nodes) {
            const edges = [];
            const fakeProducts = nodes.filter(n => n.data.fake);
            
            // Connect fake products that are close in fake score
            for (let i = 0; i < fakeProducts.length; i++) {
                for (let j = i + 1; j < fakeProducts.length; j++) {
                    const product1 = fakeProducts[i].data;
                    const product2 = fakeProducts[j].data;
                    
                    const scoreDiff = Math.abs(product1.fakeScore - product2.fakeScore);
                    const ratingDiff = Math.abs(product1.avgRating - product2.avgRating);
                    
                    // Connect products with similar fake scores and ratings
                    if (scoreDiff < 0.1 && ratingDiff < 0.5 && Math.random() < 0.1) {
                        edges.push({
                            data: {
                                id: `product_edge_${i}_${j}`,
                                source: product1.id,
                                target: product2.id,
                                color: '#ff6b6b',
                                width: 1,
                                highlightWidth: 2,
                                opacity: 0.3,
                                lineStyle: 'solid',
                                type: 'fake-connection'
                            }
                        });
                    }
                    
                    // Limit connections for performance
                    if (edges.length > 1000) break;
                }
                if (edges.length > 1000) break;
            }
            
            return edges;
        }

        function showMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 16px;
                text-align: center;
                max-width: 400px;
            `;
            messageDiv.textContent = text;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function switchView(view) {
            const clusterBtn = document.getElementById('cluster-view');
            const productBtn = document.getElementById('product-view');
            
            if (view === 'clusters') {
                currentView = 'clusters';
                clusterBtn.classList.add('active', 'btn-primary');
                clusterBtn.classList.remove('btn-secondary');
                productBtn.classList.remove('active', 'btn-primary');
                productBtn.classList.add('btn-secondary');
                
                visualizeClusters();
                hideBreadcrumb();
            } else if (view === 'products' && currentCluster !== null) {
                currentView = 'products';
                productBtn.classList.add('active', 'btn-primary');
                productBtn.classList.remove('btn-secondary');
                clusterBtn.classList.remove('active', 'btn-primary');
                clusterBtn.classList.add('btn-secondary');
                
                visualizeProducts();
                showBreadcrumb();
            }
        }

        function resetView() {
            currentCluster = null;
            cy.fit();
            cy.center();
            switchView('clusters');
        }

        function updateBreadcrumb(path) {
            document.getElementById('current-path').textContent = ` > ${path}`;
        }

        function showBreadcrumb() {
            document.getElementById('breadcrumb').style.display = 'block';
        }

        function hideBreadcrumb() {
            document.getElementById('breadcrumb').style.display = 'none';
        }

        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            
            if (searchTerm === '') {
                cy.elements().removeClass('dimmed');
                return;
            }
            
            // Dim all elements first
            cy.elements().addClass('dimmed');
            
            // Highlight matching elements
            cy.nodes().forEach(node => {
                const data = node.data();
                let matches = false;
                
                if (currentView === 'clusters') {
                    matches = data.clusterId.toString().includes(searchTerm) ||
                             (data.riskAssessment && data.riskAssessment.toLowerCase().includes(searchTerm)) ||
                             (data.sizeCategory && data.sizeCategory.toLowerCase().includes(searchTerm));
                } else {
                    matches = data.productId.toString().includes(searchTerm) ||
                             (data.fake ? 'fake' : 'real').includes(searchTerm);
                }
                
                if (matches) {
                    node.removeClass('dimmed');
                    // Also highlight connected edges
                    node.connectedEdges().removeClass('dimmed');
                }
            });
        }

        function filterByRisk(riskLevel) {
            // Reset all buttons
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('btn-primary', 'active');
                btn.classList.add('btn-secondary');
            });
            
            // Highlight active button
            const activeBtn = document.getElementById('filter-' + riskLevel);
            activeBtn.classList.remove('btn-secondary');
            activeBtn.classList.add('btn-primary', 'active');
            
            if (currentView === 'clusters') {
                cy.nodes().forEach(node => {
                    const data = node.data();
                    let visible = true;
                    
                    if (riskLevel !== 'all') {
                        if (riskLevel === 'low' && data.fakePercentage >= 5) visible = false;
                        if (riskLevel === 'medium' && (data.fakePercentage < 5 || data.fakePercentage >= 15)) visible = false;
                        if (riskLevel === 'high' && data.fakePercentage < 15) visible = false;
                    }
                    
                    if (visible) {
                        node.removeClass('dimmed');
                    } else {
                        node.addClass('dimmed');
                    }
                });
                
                // Handle edge visibility
                cy.edges().forEach(edge => {
                    const sourceVisible = !edge.source().hasClass('dimmed');
                    const targetVisible = !edge.target().hasClass('dimmed');
                    
                    if (sourceVisible && targetVisible) {
                        edge.removeClass('dimmed');
                    } else {
                        edge.addClass('dimmed');
                    }
                });
            }
        }

        function toggleConnections() {
            connectionsVisible = !connectionsVisible;
            const button = document.getElementById('toggle-connections');
            
            if (connectionsVisible) {
                cy.edges().style('display', 'element');
                button.textContent = 'Hide Connections';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-primary');
            } else {
                cy.edges().style('display', 'none');
                button.textContent = 'Show Connections';
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
            }
        }

        function toggleLabels() {
            labelsVisible = !labelsVisible;
            const button = document.getElementById('toggle-labels');
            
            if (labelsVisible) {
                cy.nodes().style('label', 'data(label)');
                button.textContent = 'Hide Labels';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-primary');
            } else {
                cy.nodes().style('label', '');
                button.textContent = 'Show Labels';
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
            }
        }

        function changeLayout() {
            const selectedLayout = document.getElementById('layout-select').value;
            
            const layoutOptions = {
                fcose: {
                    name: 'fcose',
                    quality: 'proof',
                    randomize: false,
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50,
                    nodeRepulsion: 4500,
                    idealEdgeLength: 100,
                    edgeElasticity: 0.45
                },
                cola: {
                    name: 'cola',
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50,
                    nodeSpacing: 100,
                    edgeLengthVal: 100
                },
                circle: {
                    name: 'circle',
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50,
                    radius: Math.min(cy.width(), cy.height()) / 2 - 100
                },
                grid: {
                    name: 'grid',
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50,
                    rows: Math.ceil(Math.sqrt(cy.nodes().length))
                },
                concentric: {
                    name: 'concentric',
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50,
                    concentric: function(node) {
                        return node.data('size');
                    },
                    levelWidth: function(nodes) {
                        return 2;
                    }
                },
                breadthfirst: {
                    name: 'breadthfirst',
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50,
                    directed: false,
                    spacingFactor: 1.5
                }
            };
            
            const layout = cy.layout(layoutOptions[selectedLayout]);
            layout.run();
        }
    </script>
</body>
</html> 